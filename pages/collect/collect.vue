<template>
  <view class="collect-container" @click="closeDropdown">
    <!-- 顶部工具栏 -->
    <view class="top-toolbar">
      <!-- 图层管理下拉框 -->
      <view class="layer-selector">
        <view class="picker-display" @click.stop="toggleDropdown">
          <text>{{ getDisplayText() }}</text>
          <text class="arrow" :class="{ 'arrow-up': showDropdown }">▼</text>
        </view>
        <view class="dropdown" v-if="showDropdown" @click.stop>
          <view class="dropdown-item select-all-item" @click="selectAll">
            <text>全选</text>
          </view>
          <view class="dropdown-item select-all-item" @click="selectNone">
            <text>全不选</text>
          </view>
          <view class="dropdown-divider"></view>
          <view class="dropdown-item" v-for="(item, index) in layerOptions" :key="index" @click="selectLayer(index)">
            <view class="checkbox-wrapper">
              <text class="checkbox" :class="{ checked: selectedLayers.includes(index) }">{{
                selectedLayers.includes(index) ? '✓' : '' }}</text>
              <text class="layer-name">{{ item }}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- 探点号搜索框 -->
      <view class="search-container">
        <input type="text" placeholder="搜索管点物探点号..." v-model="searchPointNo" @confirm="searchPoint"
          class="search-input" />
        <view class="search-btn" @click="searchPoint">🔍</view>
      </view>
    </view>

    <!-- 地图容器 -->
    <view class="map-wrapper">
      <map id="amap" class="amap" :longitude="mapCenter.longitude" :latitude="mapCenter.latitude" :scale="mapScale"
        :markers="markers" :polyline="polylines" :polygons="polygons" @tap="onMapTap" @click="onMapTap" @markertap="onMarkerTap"
        @regionchange="onRegionChange" @error="onMapError" @callouttap="onCalloutTap" @controltap="onControlTap"
        show-location enable-3D enable-overlooking enable-zoom enable-scroll enable-rotate 
        :enable-satellite="mapType === 'satellite'">
        <!-- 定位按钮 -->
        <cover-view class="location-btn" @tap="getCurrentLocation">
          <cover-image src="/static/icons/location.svg" class="location-icon"></cover-image>
        </cover-view>
        
        <!-- 地图中心十字准星 -->
        <cover-view class="map-crosshair" v-if="currentTool">
          <cover-view class="crosshair-horizontal"></cover-view>
          <cover-view class="crosshair-vertical"></cover-view>
        </cover-view>
        
        <!-- 创建按钮 -->
        <cover-view class="create-btn" v-if="currentTool" @tap="createAtCenter">
          <cover-text class="create-text">在此创建{{ getToolName(currentTool) }}</cover-text>
        </cover-view>
      </map>

      <!-- 右侧工具栏 -->
      <RightToolbar :mapType="mapType" :currentTool="currentTool" @toggleMapType="toggleMapType"
        @selectTool="selectTool" />
    </view>

    <!-- 管点属性弹窗 -->
    <view class="point-modal" v-if="showPointModal" @click="closePointModal">
      <view class="modal-content" @click.stop>
        <view class="modal-header">
          <text class="modal-title">管点属性</text>
          <view class="close-btn" @click="closePointModal">×</view>
        </view>
        <view class="modal-body">
          <view class="form-item">
            <text class="label">点号：</text>
            <input type="text" v-model="pointForm.pointNo" placeholder="请输入点号" />
          </view>
          <view class="form-item">
            <text class="label">管径：</text>
            <input type="number" v-model="pointForm.diameter" placeholder="请输入管径(mm)" />
          </view>
          <view class="form-item">
            <text class="label">材质：</text>
            <picker @change="onMaterialChange" :value="materialIndex" :range="materialOptions">
              <view class="picker-display">{{ materialOptions[materialIndex] }}</view>
            </picker>
          </view>
          <view class="form-item">
            <text class="label">埋深：</text>
            <input type="number" v-model="pointForm.depth" placeholder="请输入埋深(m)" />
          </view>
          <view class="form-item">
            <text class="label">备注：</text>
            <textarea v-model="pointForm.remark" placeholder="请输入备注信息"></textarea>
          </view>
        </view>
        <view class="modal-footer">
          <button class="cancel-btn" @click="closePointModal">取消</button>
          <button class="confirm-btn" @click="savePoint">确定</button>
        </view>
      </view>
    </view>

    <!-- 管线属性弹窗 -->
    <view class="line-modal" v-if="showLineModal" @click="closeLineModal">
      <view class="modal-content" @click.stop>
        <view class="modal-header">
          <text class="modal-title">管线属性</text>
          <view class="close-btn" @click="closeLineModal">×</view>
        </view>
        <view class="modal-body">
          <view class="form-item">
            <text class="label">管线类型：</text>
            <picker @change="onLineTypeChange" :value="lineTypeIndex" :range="lineTypeOptions">
              <view class="picker-display">{{ lineTypeOptions[lineTypeIndex] }}</view>
            </picker>
          </view>
          <view class="form-item">
            <text class="label">管径：</text>
            <input type="number" v-model="lineForm.diameter" placeholder="请输入管径(mm)" />
          </view>
          <view class="form-item">
            <text class="label">材质：</text>
            <picker @change="onLineMaterialChange" :value="lineMaterialIndex" :range="materialOptions">
              <view class="picker-display">{{ materialOptions[lineMaterialIndex] }}</view>
            </picker>
          </view>
          <view class="form-item">
            <text class="label">长度：</text>
            <input type="number" v-model="lineForm.length" placeholder="自动计算" disabled />
          </view>
          <view class="form-item">
            <text class="label">备注：</text>
            <textarea v-model="lineForm.remark" placeholder="请输入备注信息"></textarea>
          </view>
        </view>
        <view class="modal-footer">
          <button class="cancel-btn" @click="closeLineModal">取消</button>
          <button class="confirm-btn" @click="saveLine">确定</button>
        </view>
      </view>
    </view>

    <!-- 测量结果显示 -->
    <view class="measure-result" v-if="measureResult.show">
      <view class="result-content">
        <text class="result-title">测量结果</text>
        <text class="result-value">{{ measureResult.text }}</text>
        <view class="result-actions">
          <button class="clear-btn" @click="clearMeasure">清除</button>
          <button class="close-btn" @click="closeMeasureResult">关闭</button>
        </view>
      </view>
    </view>
  </view>
</template>

<script setup>
import { ref, reactive, onMounted, computed } from 'vue'
import RightToolbar from './components/RightToolbar.vue'

// 响应式数据
const searchPointNo = ref('')
const currentTool = ref('')
const mapType = ref('vector') // vector 或 satellite
const mapScale = ref(16)
const currentLayerIndex = ref(0)
const showDropdown = ref(false)
const selectedLayers = ref([0]) // 默认选中第一个图层
const materialIndex = ref(0)
const lineTypeIndex = ref(0)
const lineMaterialIndex = ref(0)

// 图层选项
const layerOptions = ref([
  '给水管网',
  '排水管网',
  '燃气管网',
  '热力管网',
  '电力管网',
  '通信管网'
])

// 材质选项
const materialOptions = ref([
  'PE',
  'PVC',
  '铸铁',
  '钢管',
  '水泥管',
  '其他'
])

// 管线类型选项
const lineTypeOptions = ref([
  '主管',
  '支管',
  '接户管',
  '阀门',
  '其他'
])

// 地图中心点
const mapCenter = reactive({
  longitude: 116.397428,
  latitude: 39.90923
})

// 弹窗显示状态
const showPointModal = ref(false)
const showLineModal = ref(false)

// 管点表单数据
const pointForm = reactive({
  pointNo: '',
  diameter: '',
  material: '',
  depth: '',
  remark: '',
  longitude: 0,
  latitude: 0
})

// 管线表单数据
const lineForm = reactive({
  type: '',
  diameter: '',
  material: '',
  length: '',
  remark: '',
  startPoint: null,
  endPoint: null
})

// 测量结果
const measureResult = reactive({
  show: false,
  text: '',
  type: '' // distance 或 area
})

// 地图数据
const markers = ref([])
const polylines = ref([])
const polygons = ref([])

// 临时数据
const tempPoints = ref([]) // 用于连线时的临时点
const measurePoints = ref([]) // 测量时的点

// 方法实现
const toggleDropdown = () => {
  showDropdown.value = !showDropdown.value
}

const selectLayer = (index) => {
  if (selectedLayers.value.includes(index)) {
    selectedLayers.value = selectedLayers.value.filter(i => i !== index)
  } else {
    selectedLayers.value.push(index)
  }

  // 更新当前显示的图层
  if (selectedLayers.value.length > 0) {
    currentLayerIndex.value = selectedLayers.value[0]
  }

  updateLayerDisplay()
}

const selectAll = () => {
  selectedLayers.value = layerOptions.value.map((_, index) => index)
  currentLayerIndex.value = 0
  updateLayerDisplay()
  uni.showToast({
    title: '已全选所有图层',
    icon: 'none'
  })
}

const selectNone = () => {
  selectedLayers.value = []
  updateLayerDisplay()
  uni.showToast({
    title: '已取消选择所有图层',
    icon: 'none'
  })
}

const updateLayerDisplay = () => {
  if (selectedLayers.value.length === 0) {
    // 没有选中任何图层时的处理
  } else if (selectedLayers.value.length === 1) {
    currentLayerIndex.value = selectedLayers.value[0]
  } else {
    // 多选时显示数量
    currentLayerIndex.value = selectedLayers.value[0]
  }
}

const getDisplayText = () => {
  if (selectedLayers.value.length === 0) {
    return '请选择图层'
  } else if (selectedLayers.value.length === 1) {
    return layerOptions.value[selectedLayers.value[0]]
  } else if (selectedLayers.value.length === layerOptions.value.length) {
    return '全部图层'
  } else {
    return `已选择${selectedLayers.value.length}个图层`
  }
}

const closeDropdown = () => {
  showDropdown.value = false
}

const searchPoint = () => {
  if (!searchPointNo.value.trim()) {
    uni.showToast({
      title: '请输入探点号',
      icon: 'none'
    })
    return
  }

  // 搜索逻辑
  const foundMarker = markers.value.find(marker =>
    marker.title && marker.title.includes(searchPointNo.value)
  )

  if (foundMarker) {
    mapCenter.longitude = foundMarker.longitude
    mapCenter.latitude = foundMarker.latitude
    mapScale.value = 18
    uni.showToast({
      title: '已定位到目标点',
      icon: 'success'
    })
  } else {
    uni.showToast({
      title: '未找到该探点号',
      icon: 'none'
    })
  }
}

const toggleMapType = () => {
  mapType.value = mapType.value === 'vector' ? 'satellite' : 'vector'
  uni.showToast({
    title: `已切换到${mapType.value === 'satellite' ? '影像' : '矢量'}地图`,
    icon: 'none'
  })
}

const selectTool = (tool) => {
  currentTool.value = currentTool.value === tool ? '' : tool

  // 清除临时数据
  tempPoints.value = []
  measurePoints.value = []

  const toolNames = {
    point: '管点工具',
    line: '管线工具',
    virtual: '虚拟线工具',
    shared: '共管工具',
    insert: '插入工具',
    collect: '收点工具',
    edit: '编辑工具',
    measure: '测量工具',
    flow: '流向工具',
    move: '移动工具',
    delete: '删除工具'
  }

  if (currentTool.value) {
    uni.showToast({
      title: `已选择${toolNames[tool]}`,
      icon: 'none'
    })
  }
}

//创建工具
const onMapTap = (e) => {
  console.log('地图点击事件完整对象:', JSON.stringify(e, null, 2));
  
  // H5环境下uni-app的map组件可能无法直接获取点击坐标
  // 作为临时解决方案，使用地图中心点坐标
  if (!currentTool.value) {
    uni.showToast({
      title: '请先选择创建工具',
      icon: 'none'
    });
    return;
  }
  
  // 提示用户使用地图中心点
  uni.showModal({
    title: '创建确认',
    content: `将在地图中心位置创建${getToolName(currentTool.value)}，是否继续？`,
    success: (res) => {
      if (res.confirm) {
        const longitude = mapCenter.longitude;
        const latitude = mapCenter.latitude;
        
        console.log('使用地图中心点坐标:', longitude, latitude);
        
        switch (currentTool.value) {
          case 'point':
            createPoint(longitude, latitude);
            break;
          case 'line':
            handleLineCreation(longitude, latitude);
            break;
          case 'virtual':
            createVirtualLine(longitude, latitude);
            break;
          case 'measure':
            handleMeasure(longitude, latitude);
            break;
          case 'insert':
            insertPoint(longitude, latitude);
            break;
          default:
            break;
        }
      }
    }
  });
}

// 获取工具名称
const getToolName = (tool) => {
  const toolNames = {
    point: '管点',
    line: '管线',
    virtual: '虚拟线',
    shared: '共管',
    insert: '插入点',
    collect: '收点',
    edit: '编辑',
    measure: '测量',
    flow: '流向',
    move: '移动',
    delete: '删除'
  };
  return toolNames[tool] || '元素';
}

// 在地图中心创建元素
const createAtCenter = () => {
  const longitude = mapCenter.longitude;
  const latitude = mapCenter.latitude;
  
  console.log('在地图中心创建:', longitude, latitude);
  
  switch (currentTool.value) {
    case 'point':
      createPoint(longitude, latitude);
      break;
    case 'line':
      handleLineCreation(longitude, latitude);
      break;
    case 'virtual':
      createVirtualLine(longitude, latitude);
      break;
    case 'measure':
      handleMeasure(longitude, latitude);
      break;
    case 'insert':
      insertPoint(longitude, latitude);
      break;
    default:
      break;
  }
}

// 添加其他事件处理
const onCalloutTap = (e) => {
  console.log('callout点击:', e);
}

const onControlTap = (e) => {
  console.log('control点击:', e);
}

// 打点
const createPoint = (longitude, latitude) => {
  pointForm.longitude = longitude
  pointForm.latitude = latitude
  pointForm.pointNo = `P${markers.value.length + 1}`
  showPointModal.value = true
}

// 连线（管线工具）
const handleLineCreation = (longitude, latitude) => {
  tempPoints.value.push({ longitude, latitude })

  if (tempPoints.value.length === 1) {
    uni.showToast({
      title: '请点击第二个点完成管线绘制',
      icon: 'none'
    })
  } else if (tempPoints.value.length === 2) {
    lineForm.startPoint = tempPoints.value[0]
    lineForm.endPoint = tempPoints.value[1]

    // 计算长度
    const distance = calculateDistance(
      tempPoints.value[0].latitude,
      tempPoints.value[0].longitude,
      tempPoints.value[1].latitude,
      tempPoints.value[1].longitude
    )
    lineForm.length = distance.toFixed(2)

    showLineModal.value = true
    tempPoints.value = []
  }
}

// 创建虚拟线逻辑
const createVirtualLine = (longitude, latitude) => {
  const virtualLine = {
    points: [
      { longitude, latitude },
      { longitude: longitude + 0.001, latitude: latitude + 0.001 }
    ],
    color: '#FF9800',
    width: 2,
    dottedLine: true
  }
  polylines.value.push(virtualLine)

  uni.showToast({
    title: '虚拟线创建成功',
    icon: 'success'
  })
}

// 测量工具
const handleMeasure = (longitude, latitude) => {
  measurePoints.value.push({ longitude, latitude })

  if (measurePoints.value.length >= 2) {
    let totalDistance = 0
    for (let i = 1; i < measurePoints.value.length; i++) {
      const distance = calculateDistance(
        measurePoints.value[i - 1].latitude,
        measurePoints.value[i - 1].longitude,
        measurePoints.value[i].latitude,
        measurePoints.value[i].longitude
      )
      totalDistance += distance
    }

    measureResult.text = `总长度: ${totalDistance.toFixed(2)}米`
    measureResult.type = 'distance'
    measureResult.show = true
  }
}

//插入工具
const insertPoint = (longitude, latitude) => {
  // 在最近的管线上插入点
  uni.showToast({
    title: '插入点功能开发中',
    icon: 'none'
  })
}

const calculateDistance = (lat1, lon1, lat2, lon2) => {
  const R = 6371000 // 地球半径（米）
  const dLat = (lat2 - lat1) * Math.PI / 180
  const dLon = (lon2 - lon1) * Math.PI / 180
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2)
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))
  return R * c
}

//定位
const getCurrentLocation = () => {
  uni.getLocation({
    type: 'gcj02',
    success: (res) => {
      mapCenter.longitude = res.longitude
      mapCenter.latitude = res.latitude
      mapScale.value = 18
      uni.showToast({
        title: '定位成功',
        icon: 'success'
      })
    },
    fail: () => {
      uni.showToast({
        title: '定位失败，请检查定位权限',
        icon: 'none'
      })
    }
  })
}

const onMarkerTap = (e) => {
console.log('onMarkerTap',e);

  const markerId = e.detail.markerId
  const marker = markers.value.find(m => m.id === markerId)

  if (currentTool.value === 'edit' && marker) {
    // 编辑管点
    Object.assign(pointForm, marker.data || {})
    showPointModal.value = true
  } else if (currentTool.value === 'delete' && marker) {
    // 删除管点
    uni.showModal({
      title: '确认删除',
      content: '确定要删除这个管点吗？',
      success: (res) => {
        if (res.confirm) {
          const index = markers.value.findIndex(m => m.id === markerId)
          if (index > -1) {
            markers.value.splice(index, 1)
            uni.showToast({
              title: '删除成功',
              icon: 'success'
            })
          }
        }
      }
    })
  }
}

const onRegionChange = (e) => {
  if (e.type === 'end') {
    mapCenter.longitude = e.detail.centerLocation.longitude
    mapCenter.latitude = e.detail.centerLocation.latitude
  }
}

// 弹窗相关方法
const closePointModal = () => {
  showPointModal.value = false
  Object.assign(pointForm, {
    pointNo: '',
    diameter: '',
    material: '',
    depth: '',
    remark: '',
    longitude: 0,
    latitude: 0
  })
}

const closeLineModal = () => {
  showLineModal.value = false
  Object.assign(lineForm, {
    type: '',
    diameter: '',
    material: '',
    length: '',
    remark: '',
    startPoint: null,
    endPoint: null
  })
}

// 创建管点
const savePoint = () => {
  if (!pointForm.pointNo.trim()) {
    uni.showToast({
      title: '请输入点号',
      icon: 'none'
    })
    return
  }

  const newMarker = {
    id: Date.now(),
    longitude: pointForm.longitude,
    latitude: pointForm.latitude,
    title: pointForm.pointNo,
    iconPath: '/static/icons/point.svg',
    width: 30,
    height: 30,
    data: { ...pointForm }
  }

  markers.value.push(newMarker)
  // 强制更新地图组件
  markers.value = [...markers.value]
  closePointModal()

  uni.showToast({
    title: '管点创建成功',
    icon: 'success'
  })
}

//创建管线
const saveLine = () => {
  if (!lineForm.type) {
    uni.showToast({
      title: '请选择管线类型',
      icon: 'none'
    })
    return
  }

  const newLine = {
    points: [lineForm.startPoint, lineForm.endPoint],
    color: getLineColor(lineForm.type),
    width: 4,
    data: { ...lineForm }
  }

  polylines.value.push(newLine)
  closeLineModal()

  uni.showToast({
    title: '管线创建成功',
    icon: 'success'
  })
}

const getLineColor = (type) => {
  const colors = {
    '主管': '#2196F3',
    '支管': '#4CAF50',
    '接户管': '#FF9800',
    '阀门': '#F44336',
    '其他': '#9E9E9E'
  }
  return colors[type] || '#2196F3'
}

const onMaterialChange = (e) => {
  materialIndex.value = e.detail.value
  pointForm.material = materialOptions.value[e.detail.value]
}

const onLineTypeChange = (e) => {
  lineTypeIndex.value = e.detail.value
  lineForm.type = lineTypeOptions.value[e.detail.value]
}

const onLineMaterialChange = (e) => {
  lineMaterialIndex.value = e.detail.value
  lineForm.material = materialOptions.value[e.detail.value]
}

const clearMeasure = () => {
  measurePoints.value = []
  measureResult.show = false
}

const closeMeasureResult = () => {
  measureResult.show = false
}

// 地图错误处理
const onMapError = (e) => {
  console.error('地图加载错误:', e)
  uni.showToast({
    title: '地图加载失败，请检查网络连接',
    icon: 'none',
    duration: 3000
  })
}

// 生命周期
onMounted(() => {
  // 初始化数据
  console.log('采集页面初始化完成')

  // 检查网络状态
  checkNetworkStatus()
  
  // 检查定位权限并获取当前位置
  checkLocationPermission()
})

// 检查网络状态
const checkNetworkStatus = () => {
  uni.getNetworkType({
    success: (res) => {
      console.log('网络类型:', res.networkType);
      if (res.networkType === 'none') {
        uni.showToast({
          title: '网络连接异常，请检查网络设置',
          icon: 'none',
          duration: 3000
        });
      }
    }
  });
}

// 检查定位权限
const checkLocationPermission = () => {
  // #ifdef APP-PLUS
  // App端权限检查
  const locationPermission = plus.android ? 'android.permission.ACCESS_FINE_LOCATION' : 'NSLocationWhenInUseUsageDescription';
  
  plus.android && plus.android.requestPermissions(
    ['android.permission.ACCESS_FINE_LOCATION', 'android.permission.ACCESS_COARSE_LOCATION'],
    (result) => {
      console.log('权限申请结果:', result);
      getCurrentLocation();
    },
    (error) => {
      console.log('权限申请失败:', error);
      uni.showToast({
        title: '需要定位权限才能使用地图功能',
        icon: 'none'
      });
    }
  );
  // #endif
  
  // #ifdef H5
  // H5环境直接尝试获取位置
  getCurrentLocation();
  // #endif
  
  // #ifdef MP-WEIXIN
  uni.getSetting({
    success: (res) => {
      if (res.authSetting['scope.userLocation'] !== undefined && res.authSetting['scope.userLocation'] !== true) {
        uni.showModal({
          title: '请求授权当前位置',
          content: '需要获取您的地理位置，请确认授权',
          success: (res) => {
            if (res.confirm) {
              uni.openSetting({
                success: (res) => {
                  if (res.authSetting['scope.userLocation'] === true) {
                    getCurrentLocation()
                  }
                }
              })
            }
          }
        })
      } else if (res.authSetting['scope.userLocation'] === undefined) {
        getCurrentLocation()
      } else {
        getCurrentLocation()
      }
    }
  })
  // #endif
}
</script>

<style lang="scss" scoped>
@import './collect.scss';
</style>