<template>
  <div class="collect-container" @click="closeDropdown">
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="top-toolbar">
      <!-- å›¾å±‚ç®¡ç†ä¸‹æ‹‰æ¡† -->
      <div class="layer-selector">
        <div class="picker-display" @click.stop="toggleDropdown">
          <text class="picker-text">{{ getDisplayText() }}</text>
          <text class="arrow" :class="{ 'arrow-up': showDropdown }">â–¼</text>
        </div>
        <div class="dropdown" v-if="showDropdown" @click.stop>
          <div class="dropdown-item select-all-item" @click="selectAll">
            <text>å…¨é€‰</text>
          </div>
          <div class="dropdown-item select-all-item" @click="selectNone">
            <text>å…¨ä¸é€‰</text>
          </div>
          <div class="dropdown-divider"></div>
          <div class="dropdown-item" v-for="(item, index) in layerOptions" :key="index" @click="selectLayer(index)">
            <div class="checkbox-wrapper">
              <text class="checkbox" :class="{ checked: selectedLayers.includes(index) }">{{
                selectedLayers.includes(index) ? 'âœ“' : '' }}</text>
              <text class="layer-name">{{ item }}</text>
            </div>
          </div>
        </div>
      </div>

    <!-- æ¢ç‚¹å·æœç´¢æ¡† -->
    <div class="search-container">
        <input type="text" placeholder="æœç´¢ç®¡ç‚¹ç‰©æ¢ç‚¹å·..." v-model="searchPointNo" @input="onSearchInput" @confirm="searchPoint"
            class="search-input" confirm-type="search" @click.stop />
        <div class="search-btn" @click="searchPoint">
            <text>ğŸ”</text>
        </div>
    </div>
	

    </div>

    <!-- åœ°å›¾å®¹å™¨ -->
    <div class="map-wrapper">
      <map id="amap" class="amap" :longitude="mapCenter.longitude" :latitude="mapCenter.latitude" :scale="mapScale"
        :markers="markers" :polyline="polylines" :polygons="polygons" @tap="onMapTap" @click="onMapTap"
        @markertap="onMarkerTap" @poitap="onPoiTap" @regionchange="onRegionChange" @error="onMapError" @callouttap="onCalloutTap"
        @controltap="onControlTap" show-location enable-3D enable-overlooking enable-zoom enable-scroll enable-rotate
        :enable-satellite="mapType === 'satellite'">
      </map>

      <!-- å®šä½æŒ‰é’® -->
      <div class="location-btn" @tap="getCurrentLocation">
        <text class="location-text">å®šä½</text>
      </div>

      <!-- åœ°å›¾ä¸­å¿ƒåå­—å‡†æ˜Ÿ -->
      <div class="map-crosshair" v-if="currentTool">
        <div class="crosshair-horizontal"></div>
        <div class="crosshair-vertical"></div>
      </div>

      <!-- åˆ›å»ºæŒ‰é’® -->
      <div class="create-btn" v-if="currentTool" @tap="createAtCenter">
        <text class="create-text">åœ¨æ­¤åˆ›å»º{{ getToolName(currentTool) }}</text>
      </div>

      <!-- å³ä¾§å·¥å…·æ  -->
      <div class="right-toolbar">
        <!-- å½±åƒ/çŸ¢é‡åˆ‡æ¢ -->
        <div class="tool-section">
          <div 
            class="tool-btn map-type-btn" 
            :class="{ active: mapType === 'satellite' }"
            @click="toggleMapType"
          >
            <div class="tool-icon">
              <text>ğŸ›°ï¸</text>
            </div>
            <div class="tool-text">
              <text>{{ mapType === 'satellite' ? 'å½±åƒ' : 'çŸ¢é‡' }}</text>
            </div>
          </div>
        </div>

        <!-- åˆ›å»ºå·¥å…·é›† -->
        <div class="tool-section">
          <div class="section-title">
            <text>åˆ›å»ºå·¥å…·</text>
          </div>
          <div 
            class="tool-btn" 
            :class="{ active: currentTool === 'point' }"
            @click="selectTool('point')"
          >
            <div class="tool-icon">
              <text>ğŸ“</text>
            </div>
            <div class="tool-text">
              <text>ç®¡ç‚¹</text>
            </div>
          </div>
          <div 
            class="tool-btn" 
            :class="{ active: currentTool === 'line' }"
            @click="selectTool('line')"
          >
            <div class="tool-icon">
              <text>ğŸ“</text>
            </div>
            <div class="tool-text">
              <text>ç®¡çº¿</text>
            </div>
          </div>
          <div 
            class="tool-btn" 
            :class="{ active: currentTool === 'virtual' }"
            @click="selectTool('virtual')"
          >
            <div class="tool-icon">
              <text>âš¡</text>
            </div>
            <div class="tool-text">
              <text>è™šæ‹Ÿçº¿</text>
            </div>
          </div>
          <div 
            class="tool-btn" 
            :class="{ active: currentTool === 'shared' }"
            @click="selectTool('shared')"
          >
            <div class="tool-icon">
              <text>ğŸ”—</text>
            </div>
            <div class="tool-text">
              <text>å…±ç®¡</text>
            </div>
          </div>
          <div 
            class="tool-btn" 
            :class="{ active: currentTool === 'insert' }"
            @click="selectTool('insert')"
          >
            <div class="tool-icon">
              <text>â•</text>
            </div>
            <div class="tool-text">
              <text>æ’å…¥</text>
            </div>
          </div>
          <div 
            class="tool-btn" 
            :class="{ active: currentTool === 'collect' }"
            @click="selectTool('collect')"
          >
            <div class="tool-icon">
              <text>âœ…</text>
            </div>
            <div class="tool-text">
              <text>æ”¶ç‚¹</text>
            </div>
          </div>
        </div>

        <!-- ç¼–è¾‘å·¥å…·é›† -->
        <div class="tool-section">
          <div class="section-title">
            <text>ç¼–è¾‘å·¥å…·</text>
          </div>
          <div 
            class="tool-btn" 
            :class="{ active: currentTool === 'edit' }"
            @click="selectTool('edit')"
          >
            <div class="tool-icon">
              <text>âœï¸</text>
            </div>
            <div class="tool-text">
              <text>ç¼–è¾‘</text>
            </div>
          </div>
          <div 
            class="tool-btn" 
            :class="{ active: currentTool === 'measure' }"
            @click="selectTool('measure')"
          >
            <div class="tool-icon">
              <text>ğŸ“</text>
            </div>
            <div class="tool-text">
              <text>æµ‹é‡</text>
            </div>
          </div>
          <div 
            class="tool-btn" 
            :class="{ active: currentTool === 'flow' }"
            @click="selectTool('flow')"
          >
            <div class="tool-icon">
              <text>ğŸ”„</text>
            </div>
            <div class="tool-text">
              <text>æµå‘</text>
            </div>
          </div>
          <div 
            class="tool-btn" 
            :class="{ active: currentTool === 'move' }"
            @click="selectTool('move')"
          >
            <div class="tool-icon">
              <text>ğŸ”„</text>
            </div>
            <div class="tool-text">
              <text>ç§»åŠ¨</text>
            </div>
          </div>
          <div 
            class="tool-btn" 
            :class="{ active: currentTool === 'delete' }"
            @click="selectTool('delete')"
          >
            <div class="tool-icon">
              <text>ğŸ—‘ï¸</text>
            </div>
            <div class="tool-text">
              <text>åˆ é™¤</text>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç®¡ç‚¹ä¿¡æ¯å¼¹çª— -->
    <div class="pipe-point-modal" v-if="showPipePointModal" @click="closePipePointModal">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <text class="modal-title">ç®¡ç‚¹ä¿¡æ¯</text>
          <div class="close-btn" @click="closePipePointModal">
            <text>Ã—</text>
          </div>
        </div>
        <div class="modal-body">
          <div class="info-item">
            <text class="label">ç®¡ç‚¹ç¼–å·ï¼š</text>
            <div class="value-wrapper"><text class="value">{{ selectedPipePoint.id }}</text></div>
          </div>
          <div class="info-item">
            <text class="label">ç®¡ç‚¹ç±»å‹ï¼š</text>
            <div class="value-wrapper"><text class="value">{{ selectedPipePoint.type }}</text></div>
          </div>
          <div class="info-item">
            <text class="label">ç®¡å¾„ï¼š</text>
            <div class="value-wrapper"><text class="value">{{ selectedPipePoint.diameter }}mm</text></div>
          </div>
          <div class="info-item">
            <text class="label">æè´¨ï¼š</text>
            <div class="value-wrapper"><text class="value select">{{ selectedPipePoint.material }}</text></div>
          </div>
          <div class="info-item">
            <text class="label">åŸ‹æ·±ï¼š</text>
            <div class="value-wrapper"><text class="value">{{ selectedPipePoint.depth }}m</text></div>
          </div>
          <div class="info-item">
            <text class="label">çŠ¶æ€ï¼š</text>
            <div class="value-wrapper"><text class="value">{{ selectedPipePoint.status }}</text></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç®¡ç‚¹å±æ€§å¼¹çª— -->
    <div class="point-modal" v-if="showPointModal" @click="closePointModal">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <text class="modal-title">ç®¡ç‚¹å±æ€§</text>
          <div class="close-btn" @click="closePointModal">
            <text>Ã—</text>
          </div>
        </div>
        <div class="modal-body">
          <div class="form-item">
            <text class="label">ç‚¹å·ï¼š</text>
            <input type="text" v-model="pointForm.pointNo" placeholder="è¯·è¾“å…¥ç‚¹å·" class="form-input" />
          </div>
          <div class="form-item">
            <text class="label">ç®¡å¾„ï¼š</text>
            <input type="number" v-model="pointForm.diameter" placeholder="è¯·è¾“å…¥ç®¡å¾„(mm)" class="form-input" />
          </div>
          <div class="form-item">
            <text class="label">æè´¨ï¼š</text>
            <picker @change="onMaterialChange" :value="materialIndex" :range="materialOptions">
              <div class="picker-display">
                <text>{{ materialOptions[materialIndex] }}</text>
              </div>
            </picker>
          </div>
          <div class="form-item">
            <text class="label">åŸ‹æ·±ï¼š</text>
            <input type="number" v-model="pointForm.depth" placeholder="è¯·è¾“å…¥åŸ‹æ·±(m)" class="form-input" />
          </div>
          <div class="form-item">
            <text class="label">å¤‡æ³¨ï¼š</text>
            <textarea v-model="pointForm.remark" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯" class="form-textarea"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <div class="cancel-btn" @click="closePointModal">
            <text>å–æ¶ˆ</text>
          </div>
          <div class="confirm-btn" @click="savePoint">
            <text>ç¡®å®š</text>
          </div>
        </div>
      </div>
    </div>

    <!-- ç®¡çº¿å±æ€§å¼¹çª— -->
    <div class="line-modal" v-if="showLineModal" @click="closeLineModal">
      <div class="modal-content" @click.stop>
        <div class="modal-header">
          <text class="modal-title">ç®¡çº¿å±æ€§</text>
          <div class="close-btn" @click="closeLineModal">
            <text>Ã—</text>
          </div>
        </div>
        <div class="modal-body">
          <div class="form-item">
            <text class="label">ç®¡çº¿ç±»å‹ï¼š</text>
            <picker @change="onLineTypeChange" :value="lineTypeIndex" :range="lineTypeOptions">
              <div class="picker-display">
                <text>{{ lineTypeOptions[lineTypeIndex] }}</text>
              </div>
            </picker>
          </div>
          <div class="form-item">
            <text class="label">ç®¡å¾„ï¼š</text>
            <input type="number" v-model="lineForm.diameter" placeholder="è¯·è¾“å…¥ç®¡å¾„(mm)" class="form-input" />
          </div>
          <div class="form-item">
            <text class="label">æè´¨ï¼š</text>
            <picker @change="onLineMaterialChange" :value="lineMaterialIndex" :range="materialOptions">
              <div class="picker-display">
                <text>{{ materialOptions[lineMaterialIndex] }}</text>
              </div>
            </picker>
          </div>
          <div class="form-item">
            <text class="label">é•¿åº¦ï¼š</text>
            <input type="number" v-model="lineForm.length" placeholder="è‡ªåŠ¨è®¡ç®—" disabled class="form-input" />
          </div>
          <div class="form-item">
            <text class="label">å¤‡æ³¨ï¼š</text>
            <textarea v-model="lineForm.remark" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯" class="form-textarea"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <div class="cancel-btn" @click="closeLineModal">
            <text>å–æ¶ˆ</text>
          </div>
          <div class="confirm-btn" @click="saveLine">
            <text>ç¡®å®š</text>
          </div>
        </div>
      </div>
    </div>

    <!-- æµ‹é‡ç»“æœæ˜¾ç¤º -->
    <div class="measure-result" v-if="measureResult.show">
      <div class="result-content">
        <text class="result-title">æµ‹é‡ç»“æœ</text>
        <text class="result-value">{{ measureResult.text }}</text>
        <div class="result-actions">
          <div class="clear-btn" @click="clearMeasure">
            <text>æ¸…é™¤</text>
          </div>
          <div class="close-btn" @click="closeMeasureResult">
            <text>å…³é—­</text>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, reactive, onMounted, computed } from 'vue'

export default {
  setup() {
    // å“åº”å¼æ•°æ®
    const searchPointNo = ref('')
    const currentTool = ref('')
    const mapType = ref('vector') // vector æˆ– satellite
    const mapScale = ref(16)
    const currentLayerIndex = ref(0)
    const showDropdown = ref(false)
    const selectedLayers = ref([0]) // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå›¾å±‚
    const materialIndex = ref(0)
    const lineTypeIndex = ref(0)
    const lineMaterialIndex = ref(0)

    // å›¾å±‚é€‰é¡¹
    const layerOptions = ref([
      'ç»™æ°´ç®¡ç½‘',
      'æ’æ°´ç®¡ç½‘',
      'ç‡ƒæ°”ç®¡ç½‘',
      'çƒ­åŠ›ç®¡ç½‘',
      'ç”µåŠ›ç®¡ç½‘',
      'é€šä¿¡ç®¡ç½‘'
    ])

    // æè´¨é€‰é¡¹
    const materialOptions = ref([
      'PE',
      'PVC',
      'é“¸é“',
      'é’¢ç®¡',
      'æ°´æ³¥ç®¡',
      'å…¶ä»–'
    ])

    // ç®¡çº¿ç±»å‹é€‰é¡¹
    const lineTypeOptions = ref([
      'ä¸»ç®¡',
      'æ”¯ç®¡',
      'æ¥æˆ·ç®¡',
      'é˜€é—¨',
      'å…¶ä»–'
    ])

    // åœ°å›¾ä¸­å¿ƒç‚¹
    const mapCenter = reactive({
      longitude: 116.397428,
      latitude: 39.90923
    })

    // å¼¹çª—æ˜¾ç¤ºçŠ¶æ€
    const showPointModal = ref(false)
    const showLineModal = ref(false)
    const showPipePointModal = ref(false)

    // ç®¡ç‚¹è¡¨å•æ•°æ®
    const pointForm = reactive({
      pointNo: '',
      diameter: '',
      material: '',
      depth: '',
      remark: '',
      longitude: 0,
      latitude: 0
    })

    // ç®¡çº¿è¡¨å•æ•°æ®
    const lineForm = reactive({
      type: '',
      diameter: '',
      material: '',
      length: '',
      remark: '',
      startPoint: null,
      endPoint: null
    })

    // æµ‹é‡ç»“æœ
    const measureResult = reactive({
      show: false,
      text: '',
      type: '' // distance æˆ– area
    })

    // é€‰ä¸­çš„ç®¡ç‚¹ä¿¡æ¯
    const selectedPipePoint = reactive({
      id: '',
      type: '',
      diameter: '',
      material: '',
      depth: '',
      status: ''
    })

    // åœ°å›¾æ•°æ®
    const markers = ref([])
    const polylines = ref([])
    const polygons = ref([])

    // ä¸´æ—¶æ•°æ®
    const tempPoints = ref([]) // ç”¨äºè¿çº¿æ—¶çš„ä¸´æ—¶ç‚¹
    const measurePoints = ref([]) // æµ‹é‡æ—¶çš„ç‚¹

    // æ–¹æ³•å®ç°
    const toggleDropdown = () => {
      showDropdown.value = !showDropdown.value
    }

    const selectLayer = (index) => {
      if (selectedLayers.value.includes(index)) {
        selectedLayers.value = selectedLayers.value.filter(i => i !== index)
      } else {
        selectedLayers.value.push(index)
      }

      // æ›´æ–°å½“å‰æ˜¾ç¤ºçš„å›¾å±‚
      if (selectedLayers.value.length > 0) {
        currentLayerIndex.value = selectedLayers.value[0]
      }

      updateLayerDisplay()
    }

    const selectAll = () => {
      selectedLayers.value = layerOptions.value.map((_, index) => index)
      currentLayerIndex.value = 0
      updateLayerDisplay()
      uni.showToast({
        title: 'å·²å…¨é€‰æ‰€æœ‰å›¾å±‚',
        icon: 'none'
      })
    }

    const selectNone = () => {
      selectedLayers.value = []
      updateLayerDisplay()
      uni.showToast({
        title: 'å·²å–æ¶ˆé€‰æ‹©æ‰€æœ‰å›¾å±‚',
        icon: 'none'
      })
    }

    const updateLayerDisplay = () => {
      if (selectedLayers.value.length === 0) {
        // æ²¡æœ‰é€‰ä¸­ä»»ä½•å›¾å±‚æ—¶çš„å¤„ç†
      } else if (selectedLayers.value.length === 1) {
        currentLayerIndex.value = selectedLayers.value[0]
      } else {
        // å¤šé€‰æ—¶æ˜¾ç¤ºæ•°é‡
        currentLayerIndex.value = selectedLayers.value[0]
      }
    }

    const getDisplayText = () => {
      if (selectedLayers.value.length === 0) {
        return 'è¯·é€‰æ‹©å›¾å±‚'
      } else if (selectedLayers.value.length === 1) {
        return layerOptions.value[selectedLayers.value[0]]
      } else if (selectedLayers.value.length === layerOptions.value.length) {
        return 'å…¨éƒ¨å›¾å±‚'
      } else {
        return `å·²é€‰æ‹©${selectedLayers.value.length}ä¸ªå›¾å±‚`
      }
    }

    const closeDropdown = () => {
      showDropdown.value = false
    }

    const onSearchInput = (e) => {
      searchPointNo.value = e.detail.value
    }

    const searchPoint = () => {
      console.log('æœç´¢è§¦å‘ï¼Œå½“å‰è¾“å…¥å€¼:', searchPointNo.value)
      
      if (!searchPointNo.value || !searchPointNo.value.trim()) {
        uni.showToast({
          title: 'è¯·è¾“å…¥æ¢ç‚¹å·',
          icon: 'none'
        })
        return
      }

      // æœç´¢é€»è¾‘
      const foundMarker = markers.value.find(marker =>
        marker.title && marker.title.includes(searchPointNo.value.trim())
      )

      if (foundMarker) {
        mapCenter.longitude = foundMarker.longitude
        mapCenter.latitude = foundMarker.latitude
        mapScale.value = 18
        uni.showToast({
          title: 'å·²å®šä½åˆ°ç›®æ ‡ç‚¹',
          icon: 'success'
        })
      } else {
        uni.showToast({
          title: 'æœªæ‰¾åˆ°è¯¥æ¢ç‚¹å·',
          icon: 'none'
        })
      }
    }

    const toggleMapType = () => {
      mapType.value = mapType.value === 'vector' ? 'satellite' : 'vector'
      uni.showToast({
        title: `å·²åˆ‡æ¢åˆ°${mapType.value === 'satellite' ? 'å½±åƒ' : 'çŸ¢é‡'}åœ°å›¾`,
        icon: 'none'
      })
    }

    const selectTool = (tool) => {
      currentTool.value = currentTool.value === tool ? '' : tool

      // æ¸…é™¤ä¸´æ—¶æ•°æ®
      tempPoints.value = []
      measurePoints.value = []

      const toolNames = {
        point: 'ç®¡ç‚¹å·¥å…·',
        line: 'ç®¡çº¿å·¥å…·',
        virtual: 'è™šæ‹Ÿçº¿å·¥å…·',
        shared: 'å…±ç®¡å·¥å…·',
        insert: 'æ’å…¥å·¥å…·',
        collect: 'æ”¶ç‚¹å·¥å…·',
        edit: 'ç¼–è¾‘å·¥å…·',
        measure: 'æµ‹é‡å·¥å…·',
        flow: 'æµå‘å·¥å…·',
        move: 'ç§»åŠ¨å·¥å…·',
        delete: 'åˆ é™¤å·¥å…·'
      }

      if (currentTool.value) {
        uni.showToast({
          title: `å·²é€‰æ‹©${toolNames[tool]}`,
          icon: 'none'
        })
      }
    }

    // æå–å…¬å…±çš„åœ°å›¾ç‚¹å‡»å¤„ç†é€»è¾‘
    const handleTapForCreation = (longitude, latitude) => {
      uni.showModal({
        title: 'åˆ›å»ºç¡®è®¤',
        content: `å°†åœ¨ç‚¹å‡»ä½ç½®åˆ›å»º${getToolName(currentTool.value)}ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`,
        success: (res) => {
          if (res.confirm) {
            console.log('ä½¿ç”¨åæ ‡:', longitude, latitude);

            switch (currentTool.value) {
              case 'point':
                createPoint(longitude, latitude);
                break;
              case 'line':
                handleLineCreation(longitude, latitude);
                break;
              case 'virtual':
                createVirtualLine(longitude, latitude);
                break;
              case 'measure':
                handleMeasure(longitude, latitude);
                break;
              case 'insert':
                insertPoint(longitude, latitude);
                break;
              default:
                break;
            }
          }
        }
      });
    };

    //åˆ›å»ºå·¥å…·
    const onMapTap = (e) => {
      console.log('onMapTap', e);
      
      if (!currentTool.value) {
        uni.showToast({
          title: 'è¯·å…ˆé€‰æ‹©åˆ›å»ºå·¥å…·',
          icon: 'none'
        });
        return;
      }

      // è·å–ç‚¹å‡»ä½ç½®çš„åæ ‡
      let clickLongitude, clickLatitude;
      
      if (e.detail && e.detail.longitude !== undefined && e.detail.latitude !== undefined) {
        // ä»äº‹ä»¶è¯¦æƒ…ä¸­è·å–ç‚¹å‡»åæ ‡
        clickLongitude = e.detail.longitude;
        clickLatitude = e.detail.latitude;
        console.log('è·å–åˆ°ç‚¹å‡»åæ ‡:', clickLongitude, clickLatitude);
      } else {
        // å¦‚æœæ— æ³•è·å–ç‚¹å‡»åæ ‡ï¼Œä½¿ç”¨åœ°å›¾ä¸­å¿ƒç‚¹ä½œä¸ºå¤‡é€‰
        clickLongitude = mapCenter.longitude;
        clickLatitude = mapCenter.latitude;
        console.log('ä½¿ç”¨åœ°å›¾ä¸­å¿ƒç‚¹åæ ‡ä½œä¸ºå¤‡é€‰:', clickLongitude, clickLatitude);
      }

      handleTapForCreation(clickLongitude, clickLatitude);
    }

    // è·å–å·¥å…·åç§°
    const getToolName = (tool) => {
      const toolNames = {
        point: 'ç®¡ç‚¹',
        line: 'ç®¡çº¿',
        virtual: 'è™šæ‹Ÿçº¿',
        shared: 'å…±ç®¡',
        insert: 'æ’å…¥ç‚¹',
        collect: 'æ”¶ç‚¹',
        edit: 'ç¼–è¾‘',
        measure: 'æµ‹é‡',
        flow: 'æµå‘',
        move: 'ç§»åŠ¨',
        delete: 'åˆ é™¤'
      };
      return toolNames[tool] || 'å…ƒç´ ';
    }

    // åœ¨åœ°å›¾ä¸­å¿ƒåˆ›å»ºå…ƒç´ 
    const createAtCenter = () => {
      const longitude = mapCenter.longitude;
      const latitude = mapCenter.latitude;

      console.log('åœ¨åœ°å›¾ä¸­å¿ƒåˆ›å»º:', longitude, latitude);

      switch (currentTool.value) {
        case 'point':
          createPoint(longitude, latitude);
          break;
        case 'line':
          handleLineCreation(longitude, latitude);
          break;
        case 'virtual':
          createVirtualLine(longitude, latitude);
          break;
        case 'measure':
          handleMeasure(longitude, latitude);
          break;
        case 'insert':
          insertPoint(longitude, latitude);
          break;
        default:
          break;
      }
    }

    // POIç‚¹å‡»äº‹ä»¶å¤„ç†ï¼ˆå¤„ç†åœ°å›¾ä¸Šçš„å…´è¶£ç‚¹ï¼Œå¦‚"ä¸œé—¨"ã€"å¹¼å„¿å›­"ç­‰ï¼‰
    const onPoiTap = (e) => {
      console.log('POIç‚¹å‡»äº‹ä»¶:', e);
      
      if (!currentTool.value) {
        uni.showToast({
          title: 'è¯·å…ˆé€‰æ‹©åˆ›å»ºå·¥å…·',
          icon: 'none'
        });
        return;
      }

      // è·å–POIç‚¹å‡»ä½ç½®çš„åæ ‡
      let clickLongitude, clickLatitude;
      
      if (e.detail && e.detail.longitude !== undefined && e.detail.latitude !== undefined) {
        clickLongitude = e.detail.longitude;
        clickLatitude = e.detail.latitude;
        console.log('ä»POIäº‹ä»¶è·å–åæ ‡:', clickLongitude, clickLatitude);
      } else {
        // å¦‚æœæ— æ³•è·å–åæ ‡ï¼Œä½¿ç”¨åœ°å›¾ä¸­å¿ƒç‚¹
        clickLongitude = mapCenter.longitude;
        clickLatitude = mapCenter.latitude;
        console.log('POIäº‹ä»¶æ— åæ ‡ï¼Œä½¿ç”¨åœ°å›¾ä¸­å¿ƒç‚¹:', clickLongitude, clickLatitude);
      }

      // æç¤ºç”¨æˆ·ç¡®è®¤åˆ›å»ºä½ç½®
      uni.showModal({
        title: 'åˆ›å»ºç¡®è®¤',
        content: `å°†åœ¨${e.detail?.name || 'POIç‚¹'}ä½ç½®åˆ›å»º${getToolName(currentTool.value)}ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`,
        success: (res) => {
          if (res.confirm) {
            console.log('ç¡®è®¤åœ¨POIä½ç½®åˆ›å»ºï¼Œåæ ‡:', clickLongitude, clickLatitude);

            switch (currentTool.value) {
              case 'point':
                createPoint(clickLongitude, clickLatitude);
                break;
              case 'line':
                handleLineCreation(clickLongitude, clickLatitude);
                break;
              case 'virtual':
                createVirtualLine(clickLongitude, clickLatitude);
                break;
              case 'measure':
                handleMeasure(clickLongitude, clickLatitude);
                break;
              case 'insert':
                insertPoint(clickLongitude, clickLatitude);
                break;
              default:
                break;
            }
          }
        }
      });
    }

    // æ·»åŠ å…¶ä»–äº‹ä»¶å¤„ç†
    const onCalloutTap = (e) => {
      console.log('calloutç‚¹å‡»:', e);
    }

    // ç›‘å¬åœ°å›¾æ§ä»¶çš„ç‚¹å‡»äº‹ä»¶â€‹â€‹
    const onControlTap = (e) => {
      console.log('controlç‚¹å‡»:', e);
    }

    // æ‰“ç‚¹
    const createPoint = (longitude, latitude) => {
      pointForm.longitude = longitude
      pointForm.latitude = latitude
      pointForm.pointNo = `P${markers.value.length + 1}`
      showPointModal.value = true
    }

    // ç®¡çº¿å·¥å…·
    const handleLineCreation = (longitude, latitude) => {
      tempPoints.value.push({ longitude, latitude })

      if (tempPoints.value.length === 1) {
        uni.showToast({
          title: 'è¯·ç‚¹å‡»ç¬¬äºŒä¸ªç‚¹å®Œæˆç®¡çº¿ç»˜åˆ¶',
          icon: 'none'
        })
      } else if (tempPoints.value.length === 2) {
        lineForm.startPoint = tempPoints.value[0]
        lineForm.endPoint = tempPoints.value[1]

        // è®¡ç®—é•¿åº¦
        const distance = calculateDistance(
          tempPoints.value[0].latitude,
          tempPoints.value[0].longitude,
          tempPoints.value[1].latitude,
          tempPoints.value[1].longitude
        )

        if (distance > 0) {
          lineForm.length = distance.toFixed(2)
        } else {
          uni.showToast({
            title: 'ç®¡çº¿é•¿åº¦ä¸èƒ½ä¸º0ï¼Œè¯·é‡æ–°é€‰æ‹©ç‚¹',
            icon: 'none'
          })
          tempPoints.value = []
          return
        }

        showLineModal.value = true
        tempPoints.value = []
      }
    }

    // åˆ›å»ºè™šæ‹Ÿçº¿é€»è¾‘
    const createVirtualLine = (longitude, latitude) => {
      const virtualLine = {
        points: [
          { longitude, latitude },
          { longitude: longitude + 0.001, latitude: latitude + 0.001 }
        ],
        color: '#FF9800',
        width: 2,
        dottedLine: true
      }
      polylines.value.push(virtualLine)

      uni.showToast({
        title: 'è™šæ‹Ÿçº¿åˆ›å»ºæˆåŠŸ',
        icon: 'success'
      })
    }

    // æµ‹é‡å·¥å…·
    const handleMeasure = (longitude, latitude) => {
      measurePoints.value.push({ longitude, latitude })

      if (measurePoints.value.length >= 2) {
        let totalDistance = 0
        for (let i = 1; i < measurePoints.value.length; i++) {
          const distance = calculateDistance(
            measurePoints.value[i - 1].latitude,
            measurePoints.value[i - 1].longitude,
            measurePoints.value[i].latitude,
            measurePoints.value[i].longitude
          )
          totalDistance += distance
        }

        measureResult.text = `æ€»é•¿åº¦: ${totalDistance.toFixed(2)}ç±³`
        measureResult.type = 'distance'
        measureResult.show = true
      }
    }

    //æ’å…¥å·¥å…·
    const insertPoint = (longitude, latitude) => {
      // åœ¨æœ€è¿‘çš„ç®¡çº¿ä¸Šæ’å…¥ç‚¹
      uni.showToast({
        title: 'æ’å…¥ç‚¹åŠŸèƒ½å¼€å‘ä¸­',
        icon: 'none'
      })
    }

    // è®¡ç®—åœ°çƒä¸Šä¸¤ç‚¹ä¹‹é—´çš„å¤§åœ†è·ç¦»ï¼ˆä¸¤ç‚¹ä¹‹é—´çš„æœ€çŸ­è·ç¦»ï¼‰
    const calculateDistance = (lat1, lon1, lat2, lon2) => {
      const R = 6371000 // åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
      const dLat = (lat2 - lat1) * Math.PI / 180
      const dLon = (lon2 - lon1) * Math.PI / 180
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2)
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))
      return R * c
    }

    //å®šä½
    const getCurrentLocation = () => {
      uni.getLocation({
        type: 'gcj02',
        success: (res) => {
          mapCenter.longitude = res.longitude
          mapCenter.latitude = res.latitude
          mapScale.value = 18
          uni.showToast({
            title: 'å®šä½æˆåŠŸ',
            icon: 'success'
          })
        },
        fail: () => {
          uni.showToast({
            title: 'å®šä½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®šä½æƒé™',
            icon: 'none'
          })
        }
      })
    }

    // å®ç°åœ°å›¾äº¤äº’åŠŸèƒ½
    const onMarkerTap = (e) => {
      console.log('onMarkerTap', e);

      if (!e.detail || !e.detail.markerId) {
        return
      }

      const markerId = e.detail.markerId
      const marker = markers.value.find(m => m.id === markerId)

      // å¦‚æœå½“å‰å·¥å…·æ˜¯â€œç®¡ç‚¹â€ï¼Œåˆ™å°†æ ‡è®°ç‚¹ç‚¹å‡»è§†ä¸ºåœ°å›¾ç‚¹å‡»ï¼Œç”¨äºåˆ›å»ºç®¡ç‚¹
      if (currentTool.value === 'point') {
        // ä»markerå¯¹è±¡è·å–åæ ‡ï¼Œè¿™æ˜¯æˆ‘ä»¬åˆ›å»ºmarkeræ—¶å­˜å‚¨çš„åæ ‡
        if (marker && marker.longitude !== undefined && marker.latitude !== undefined) {
          console.log('ä»markerå¯¹è±¡è·å–åæ ‡:', marker.longitude, marker.latitude);
          handleTapForCreation(marker.longitude, marker.latitude);
        } else {
          // å¦‚æœmarkeræ²¡æœ‰åæ ‡ä¿¡æ¯ï¼Œä½¿ç”¨åœ°å›¾ä¸­å¿ƒç‚¹
          console.log('markeræ²¡æœ‰åæ ‡ä¿¡æ¯ï¼Œä½¿ç”¨åœ°å›¾ä¸­å¿ƒç‚¹:', mapCenter.longitude, mapCenter.latitude);
          handleTapForCreation(mapCenter.longitude, mapCenter.latitude);
        }
        return; // é˜»æ­¢åç»­çš„æ ‡è®°ç‚¹å¤„ç†é€»è¾‘
      }

      if (currentTool.value === 'edit' && marker) {
        // ç¼–è¾‘ç®¡ç‚¹
        Object.assign(pointForm, marker.data || {})
        showPointModal.value = true
      } else if (currentTool.value === 'delete' && marker) {
        // åˆ é™¤ç®¡ç‚¹
        uni.showModal({
          title: 'ç¡®è®¤åˆ é™¤',
          content: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç®¡ç‚¹å—ï¼Ÿ',
          success: (res) => {
            if (res.confirm) {
              const index = markers.value.findIndex(m => m.id === markerId)
              if (index > -1) {
                markers.value.splice(index, 1)
                uni.showToast({
                  title: 'åˆ é™¤æˆåŠŸ',
                  icon: 'success'
                })
              }
            }
          }
        })
      } else if (!currentTool.value && marker) {
        // æ²¡æœ‰é€‰æ‹©å·¥å…·æ—¶ï¼Œæ˜¾ç¤ºç®¡ç‚¹ä¿¡æ¯
        const data = marker.data || {}
        Object.assign(selectedPipePoint, {
          id: data.pointNo || marker.title || 'æœªçŸ¥',
          type: 'ç®¡ç‚¹',
          diameter: data.diameter || 'æœªçŸ¥',
          material: data.material || 'æœªçŸ¥',
          depth: data.depth || 'æœªçŸ¥',
          status: 'æ­£å¸¸'
        })
        showPipePointModal.value = true
      }
    }

    // ç›‘å¬åœ°å›¾çš„ç§»åŠ¨ã€ç¼©æ”¾ç­‰æ“ä½œâ€‹â€‹
    const onRegionChange = (e) => {
      // ä»…åœ¨å˜åŒ–ç»“æŸæ—¶ï¼ˆe.type === 'end'ï¼‰æ›´æ–°ä¸­å¿ƒç‚¹åæ ‡â€‹
      if (e.type === 'end' && e.detail && e.detail.centerLocation) {
        mapCenter.longitude = e.detail.centerLocation.longitude
        mapCenter.latitude = e.detail.centerLocation.latitude
      }
    }

    // å¼¹çª—ç›¸å…³æ–¹æ³•
    const closePointModal = () => {
      showPointModal.value = false
      Object.assign(pointForm, {
        pointNo: '',
        diameter: '',
        material: '',
        depth: '',
        remark: '',
        longitude: 0,
        latitude: 0
      })
    }

    // ç®¡çº¿å–æ¶ˆæŒ‰é’®
    const closeLineModal = () => {
      showLineModal.value = false
      Object.assign(lineForm, {
        type: '',
        diameter: '',
        material: '',
        length: '',
        remark: '',
        startPoint: null,
        endPoint: null
      })
    }

    // å…³é—­ç®¡ç‚¹ä¿¡æ¯å¼¹çª—
    const closePipePointModal = () => {
      showPipePointModal.value = false
    }

    // åˆ›å»ºç®¡ç‚¹
    const savePoint = () => {
      if (!pointForm.pointNo.trim()) {
        uni.showToast({
          title: 'è¯·è¾“å…¥ç‚¹å·',
          icon: 'none'
        })
        return
      }

      const newMarker = {
        id: Date.now(),
        longitude: pointForm.longitude,
        latitude: pointForm.latitude,
        title: pointForm.pointNo,
        iconPath: '/static/icons/point.svg',
        width: 30,
        height: 30,
        data: { ...pointForm }
      }

      markers.value.push(newMarker)
      // å¼ºåˆ¶æ›´æ–°åœ°å›¾ç»„ä»¶
      markers.value = [...markers.value]
      closePointModal()

      uni.showToast({
        title: 'ç®¡ç‚¹åˆ›å»ºæˆåŠŸ',
        icon: 'success'
      })
    }

    //åˆ›å»ºç®¡çº¿
    const saveLine = () => {
      if (!lineForm.type) {
        uni.showToast({
          title: 'è¯·é€‰æ‹©ç®¡çº¿ç±»å‹',
          icon: 'none'
        })
        return
      }
      const newLine = {
        points: [lineForm.startPoint, lineForm.endPoint],
        color: getLineColor(lineForm.type),
        width: 4,
        data: { ...lineForm }
      }
      polylines.value.push(newLine)
      closeLineModal()
      uni.showToast({
        title: 'ç®¡çº¿åˆ›å»ºæˆåŠŸ',
        icon: 'success'
      })
    }

    // ç®¡çº¿é¢œè‰²é€‰æ‹©
    const getLineColor = (type) => {
      const colors = {
        'ä¸»ç®¡': '#2196F3',
        'æ”¯ç®¡': '#4CAF50',
        'æ¥æˆ·ç®¡': '#FF9800',
        'é˜€é—¨': '#F44336',
        'å…¶ä»–': '#9E9E9E'
      }
      return colors[type] || '#2196F3'
    }

    // ç®¡ç‚¹æè´¨é€‰æ‹©
    const onMaterialChange = (e) => {
      materialIndex.value = e.detail.value
      pointForm.material = materialOptions.value[e.detail.value]
    }

    // ç®¡çº¿ç±»å‹
    const onLineTypeChange = (e) => {
      lineTypeIndex.value = e.detail.value
      lineForm.type = lineTypeOptions.value[e.detail.value]
    }

    // ç®¡çº¿æè´¨é€‰æ‹©
    const onLineMaterialChange = (e) => {
      lineMaterialIndex.value = e.detail.value
      lineForm.material = materialOptions.value[e.detail.value]
    }

    // æ¸…é™¤æµ‹é‡ç»“æœ
    const clearMeasure = () => {
      measurePoints.value = []
      measureResult.show = false
    }

    //å…³é—­æµ‹é‡ç»“æœ
    const closeMeasureResult = () => {
      measureResult.show = false
    }

    // åœ°å›¾é”™è¯¯å¤„ç†
    const onMapError = (e) => {
      console.error('åœ°å›¾åŠ è½½é”™è¯¯:', e)
      uni.showToast({
        title: 'åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',
        icon: 'none',
        duration: 3000
      })
    }

    // ç”Ÿå‘½å‘¨æœŸ
    onMounted(() => {
      // åˆå§‹åŒ–æ•°æ®
      console.log('é‡‡é›†é¡µé¢åˆå§‹åŒ–å®Œæˆ')

      // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
      checkNetworkStatus()

      // æ£€æŸ¥å®šä½æƒé™å¹¶è·å–å½“å‰ä½ç½®
      checkLocationPermission()
    })

    // æ£€æŸ¥ç½‘ç»œçŠ¶æ€
    const checkNetworkStatus = () => {
      uni.getNetworkType({
        success: (res) => {
          console.log('ç½‘ç»œç±»å‹:', res.networkType);
          if (res.networkType === 'none') {
            uni.showToast({
              title: 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®',
              icon: 'none',
              duration: 3000
            });
          }
        }
      });
    }

    // æ£€æŸ¥å®šä½æƒé™
    const checkLocationPermission = () => {
      getCurrentLocation();
    }

    return {
      // å“åº”å¼æ•°æ®
      searchPointNo,
      currentTool,
      mapType,
      mapScale,
      currentLayerIndex,
      showDropdown,
      selectedLayers,
      materialIndex,
      lineTypeIndex,
      lineMaterialIndex,
      layerOptions,
      materialOptions,
      lineTypeOptions,
      mapCenter,
      showPointModal,
      showLineModal,
      showPipePointModal,
      pointForm,
      lineForm,
      measureResult,
      selectedPipePoint,
      markers,
      polylines,
      polygons,
      tempPoints,
      measurePoints,

      // æ–¹æ³•
      toggleDropdown,
      selectLayer,
      selectAll,
      selectNone,
      updateLayerDisplay,
      getDisplayText,
      closeDropdown,
      onSearchInput,
      searchPoint,
      toggleMapType,
      selectTool,
      onMapTap,
      getToolName,
      createAtCenter,
      onPoiTap,
      onCalloutTap,
      onControlTap,
      createPoint,
      handleLineCreation,
      createVirtualLine,
      handleMeasure,
      insertPoint,
      calculateDistance,
      getCurrentLocation,
      onMarkerTap,
      onRegionChange,
      closePointModal,
      closeLineModal,
      closePipePointModal,
      savePoint,
      saveLine,
      getLineColor,
      onMaterialChange,
      onLineTypeChange,
      onLineMaterialChange,
      clearMeasure,
      closeMeasureResult,
      onMapError,
      checkNetworkStatus,
      checkLocationPermission,
      handleTapForCreation // æ·»åŠ æ–°å‡½æ•°åˆ°è¿”å›å¯¹è±¡
    }
  }
}
</script>

<style>
.collect-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  background-color: #f5f5f5;
}

.top-toolbar {
  height: 60px; /* æ¢å¤é«˜åº¦ */
  background-color: #2196F3;
  display: flex;
  flex-direction: row;
  align-items: center;
  padding-left: 20px;
  padding-right: 20px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  z-index: 10;
}

.layer-selector {
  margin-right: 20px;
  position: relative;
  flex-shrink: 0;
}

.picker-display {
  display: flex;
  flex-direction: row;
  align-items: center;
  white-space: nowrap;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 12px;
  padding-right: 12px;
  background-color: rgba(255,255,255,0.9);
  border-radius: 6px;
  font-size: 18px;
}

.picker-text {
	flex: 1;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

.arrow {
  margin-left: 8px;
  font-size: 16px;
  color: #666;
  transition-duration: 300ms;
  transition-property: transform;
}

.arrow-up {
  transform: rotate(180deg);
}

.dropdown {
  position: fixed;
  top: 80px;
  left: 20px;
  min-width: 120px;
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 99999;
  max-height: 400px;
  border: 1px solid #e0e0e0;
}

.dropdown-item {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 15px;
  padding-right: 15px;
  border-bottom-width: 1px;
  border-bottom-color: #f0f0f0;
  border-bottom-style: solid;
}

.select-all-item {
  background-color: #e3f2fd;
  color: #2196F3;
  font-weight: bold;
  text-align: center;
  font-size: 14px;
}

.checkbox-wrapper {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: flex-start;
}

.checkbox {
  width: 18px;
  height: 18px;
  border-width: 1px;
  border-color: #ddd;
  border-style: solid;
  border-radius: 3px;
  margin-right: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: white;
  flex-shrink: 0;
}

.checked {
  background-color: #2196F3;
  border-color: #2196F3;
}

.layer-name {
  flex: 1;
  font-size: 14px;
  line-height: 18px;
}

.dropdown-divider {
  height: 1px;
  background-color: #e0e0e0;
  margin-top: 4px;
  margin-bottom: 4px;
}

.search-container {
  flex: 1;
  display: flex;
  flex-direction: row;
  align-items: center;
  background-color: rgba(255,255,255,0.9);
  border-radius: 8px;
  padding: 8px;
  margin-left: 10px;
}

.search-input {
  flex: 1;
  background-color: transparent;
  border: none;
  font-size: 16px;
  color: #333;
  padding: 8px 12px;
}

.search-btn {
  width: 40px;
  height: 40px;
  background-color: #2196F3;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 8px;
}

.search-btn text {
  font-size: 18px;
  color: white;
}



.map-wrapper {
  flex: 1;
  position: relative;
  min-height: 800px;
}

.amap {
  width: 750px;
  flex: 1;
  min-height: 800px;
}

.location-btn {
  position: fixed;
  left: 20px;
  bottom: 150px;
  width: 60px;
  height: 60px;
  background-color: #2196F3;
  border-radius: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 16px rgba(33, 150, 243, 0.4);
  z-index: 998;
  border: 2px solid white;
}

.location-text {
  font-size: 16px;
  color: white;
  font-weight: bold;
}

.map-crosshair {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  z-index: 100;
}

.crosshair-horizontal {
  position: absolute;
  top: -2px;
  left: -30px;
  width: 60px;
  height: 4px;
  background-color: #ff4444;
  border-radius: 2px;
  box-shadow: 0 0 8px rgba(255, 68, 68, 0.5);
}

.crosshair-vertical {
  position: absolute;
  top: -30px;
  left: -2px;
  width: 4px;
  height: 60px;
  background-color: #ff4444;
  border-radius: 2px;
  box-shadow: 0 0 8px rgba(255, 68, 68, 0.5);
}

.create-btn {
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #2196F3;
  color: white;
  padding-top: 20px;
  padding-bottom: 20px;
  padding-left: 40px;
  padding-right: 40px;
  border-radius: 50px;
  box-shadow: 0 8px 24px rgba(33, 150, 243, 0.3);
  z-index: 100;
}

.create-text {
  font-size: 28px;
  color: white;
  font-weight: 500;
}

.pipe-point-modal {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 99999;
}

.info-item {
  display: flex;
  flex-direction: row; /* ç¡®ä¿å­å…ƒç´ æ°´å¹³æ’åˆ— */
  align-items: center;
  padding-top: 16rpx;
  padding-bottom: 16rpx;
  border-bottom-width: 2rpx;
  border-bottom-color: #f0f0f0;
  border-bottom-style: solid;
}

.info-item .label {
  width: 160rpx;
  font-size: 28rpx;
  color: #666;
  font-weight: bold;
  margin-bottom: 0;
}

.info-item .value-wrapper {
  width: 500rpx; /* è®¾ç½®å›ºå®šå®½åº¦ä»¥åŒ¹é… form-input */
}

.info-item .value {
  width: 100%; /* è®©æ–‡æœ¬å¡«å……å…¶çˆ¶å®¹å™¨ */
  font-size: 28rpx;
  color: #333;
}

.point-modal, .line-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 998;
}

.modal-content {
  width: 680rpx;
  background-color: white;
  border-radius: 16rpx;
  overflow: hidden;
}

.modal-header {
  padding-top: 30rpx;
  padding-bottom: 30rpx;
  padding-left: 40rpx;
  padding-right: 40rpx;
  background-color: #2196F3;
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 32rpx;
  font-weight: bold;
  color: white;
}

.modal-header > .close-btn {
  width: 48rpx;
  height: 48rpx;
  border-radius: 24rpx;
  background-color: rgba(255,255,255,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36rpx;
}

.modal-body {
  padding: 40rpx;
}

.form-item {
  margin-bottom: 30rpx;
}

.label {
  display: block;
  margin-bottom: 10rpx;
  font-size: 28rpx;
  color: #333;
  font-weight: bold;
}

.form-input, .form-textarea {
  width: 500rpx;
  height: 72rpx;
  border-width: 1px;
  border-color: #ddd;
  border-style: solid;
  border-radius: 8rpx;
  font-size: 28rpx;
  box-sizing: border-box;
}

.form-textarea {
  height: 120rpx;
}

.form-item .picker-display {
  width: 100%;
  padding-top: 16rpx;
  padding-bottom: 16rpx;
  padding-left: 24rpx;
  padding-right: 24rpx;
  border-width: 1px;
  border-color: #ddd;
  border-style: solid;
  border-radius: 8rpx;
  font-size: 28rpx;
  background-color: #fff;
  box-sizing: border-box;
}

.modal-footer {
  padding-top: 30rpx;
  padding-bottom: 30rpx;
  padding-left: 40rpx;
  padding-right: 40rpx;
  background-color: #f8f8f8;
  display: flex;
  flex-direction: row;
  justify-content: flex-end;
}

.cancel-btn, .confirm-btn {
  padding-top: 16rpx;
  padding-bottom: 16rpx;
  padding-left: 40rpx;
  padding-right: 40rpx;
  border-radius: 8rpx;
  border-width: 0;
  font-size: 28rpx;
  margin-left: 20rpx;
}

.cancel-btn {
  background-color: #f5f5f5;
  color: #666;
}

.confirm-btn {
  background-color: #2196F3;
  color: white;
}

.measure-result {
  position: fixed;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 999;
}

.result-content {
  background-color: white;
  padding-top: 15px;
  padding-bottom: 15px;
  padding-left: 20px;
  padding-right: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  text-align: center;
}

.result-title {
  font-size: 14px;
  color: #666;
  margin-bottom: 5px;
}

.result-value {
  font-size: 18px;
  font-weight: bold;
  color: #2196F3;
  margin-bottom: 15px;
}

.result-actions {
  display: flex;
}

.clear-btn, .close-btn {
  flex: 1;
  padding-top: 6px;
  padding-bottom: 6px;
  padding-left: 12px;
  padding-right: 12px;
  border-radius: 4px;
  border-width: 0;
  font-size: 12px;
  margin-left: 5px;
  margin-right: 5px;
}

.clear-btn {
  background-color: #f44336;
  color: white;
}

.close-btn {
  background-color: #666;
  color: white;
}

.right-toolbar {
  position: absolute;
  right: 20px;
  top: 20px;
  width: 120px;
  height: 460vh;
  background-color: white;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  z-index: 998;
  pointer-events: auto;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.tool-section {
  border-bottom-width: 1px;
  border-bottom-color: #f0f0f0;
  border-bottom-style: solid;
  flex-shrink: 0;
}

.section-title {
  padding-top: 12px;
  padding-bottom: 12px;
  padding-left: 16px;
  padding-right: 16px;
  font-size: 16px;
  color: #666;
  background-color: #f8f8f8;
  text-align: center;
  font-weight: bold;
}

.tool-btn {
  display: flex;
  flex-direction: row;
  align-items: center;
  padding-top: 6px;
  padding-bottom: 6px;
  padding-left: 8px;
  padding-right: 8px;
  transition-duration: 300ms;
  transition-property: background-color;
  pointer-events: auto;
}

.tool-btn:active {
  background-color: #f0f0f0;
}

.active {
  background-color: #e3f2fd;
  color: #2196F3;
}

.map-type-btn.active {
  background-color: #e8f5e8;
  color: #4CAF50;
}

.tool-icon {
  font-size: 18px;
  margin-right: 6px;
  flex-shrink: 0;
}

.tool-text {
  font-size: 12px;
  text-align: left;
  line-height: 1.2;
  flex: 1;
}
</style>