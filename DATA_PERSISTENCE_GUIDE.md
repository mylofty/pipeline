# 数据持久性说明 - HBuilderX调试环境

## 🔄 数据保存机制

### Android真机调试
**✅ 数据会持久保存**
- 数据库文件存储在：`/data/data/应用包名/databases/`
- 应用数据存储在：`/data/data/应用包名/files/`
- 重新运行调试**不会**清除数据
- 只有以下操作会清除数据：
  - 卸载应用
  - 清除应用数据（设置 → 应用管理）
  - 代码中强制重新初始化

### 浏览器调试（H5）
**⚠️ 数据可能丢失**
- 使用 `localStorage` 存储数据
- 清除浏览器缓存会丢失数据
- 无痕模式下数据不持久
- 浏览器存储限制可能导致数据丢失

### 微信开发者工具
**✅ 数据通常保存**
- 数据存储在开发者工具的模拟环境
- 清除项目缓存会丢失数据
- 重启开发者工具数据保留

## 📱 你的项目具体情况

### 首次运行流程
```
1. 应用启动
2. 检测 static/database/base.db 文件
3. Android: 复制到 /data/data/包名/files/base.db
4. 初始化数据库连接
5. 如果是新数据库，导入原始数据
6. 如果已存在，直接使用现有数据
```

### 后续调试运行
```
1. 应用启动
2. 检测本地数据库文件是否存在
3. 如果存在：直接连接使用（保留所有数据）
4. 如果不存在：重新从 static/database/base.db 初始化
```

## 🧪 测试数据持久性

### 简单测试方法
1. **运行应用**，访问数据库查看器
2. **记录当前数据**（比如projects表有多少条记录）
3. **添加测试数据**（创建一个新项目）
4. **重新运行调试**
5. **检查数据**：
   - 原始数据还在 ✅
   - 新添加的测试项目还在 ✅
   - 说明数据持久保存

### 详细测试步骤
```javascript
// 1. 首次运行后，在控制台执行
console.log('=== 数据持久性测试 ===');

// 2. 查看当前项目数量
// 访问 /pages/test/database-viewer
// 选择 projects 表，记录数量

// 3. 添加测试项目
// 可以通过项目管理页面添加，或在控制台执行：
import projectService from '@/services/projectService.js';
projectService.createProject({
  project_name: '持久性测试项目_' + Date.now(),
  work_group: 'TEST',
  offline_map_path: '',
  map_type: 'shp'
});

// 4. 重新运行调试，再次检查项目数量
```

## 📊 数据状态检查

### 检查数据是否为原始数据
访问：`/pages/test/database-viewer`
1. 点击"检查原始数据"
2. 查看诊断结果：
   - ✅ "检测到原始数据" - 使用了你的base.db
   - ⚠️ "未检测到数据" - 使用了空表
   - ⚠️ "数据来源不确定" - 混合数据

### 检查数据是否持久保存
1. **第一次运行**：记录各表的记录数
2. **添加测试数据**：创建项目、管点等
3. **重新调试**：检查数据是否还在
4. **多次重复**：确认数据稳定保存

## 🔧 强制重新初始化

### 如果想重新加载原始数据
**Android设备**：
```bash
# 方法1：卸载重装
adb uninstall 你的应用包名
# 然后重新安装调试

# 方法2：清除应用数据
adb shell pm clear 你的应用包名
```

**代码方式**：
```javascript
// 在 utils/database.js 中添加强制重置方法
async forceReset() {
  try {
    // 删除现有数据库文件
    await this.adapter.close();
    // 重新初始化
    await this.init();
    console.log('数据库强制重置完成');
  } catch (error) {
    console.error('强制重置失败:', error);
  }
}
```

## 📝 最佳实践建议

### 开发阶段
1. **首次运行**：确认加载了原始数据
2. **功能测试**：添加测试数据验证功能
3. **持久性验证**：多次重启确认数据保存
4. **清理测试**：定期清理测试数据

### 生产部署
1. **数据备份**：定期备份重要数据
2. **版本升级**：考虑数据库结构变更
3. **数据迁移**：提供数据导入导出功能

## 🎯 总结

**对于你的Android调试环境**：
- ✅ 数据会持久保存
- ✅ 重新运行调试不会丢失数据
- ✅ 原始base.db数据只在首次加载
- ✅ 后续的数据修改都会保留

**验证方法**：
1. 使用数据库查看器检查当前数据状态
2. 添加测试数据后重新调试验证持久性
3. 通过诊断功能确认是否使用了原始数据

现在你可以放心地进行开发和测试，数据不会因为重新调试而丢失！