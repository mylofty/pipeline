<!DOCTYPE html>
<html>
<head>
    <title>管线功能测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .marker { display: inline-block; margin: 5px; padding: 10px; background: #f0f0f0; cursor: pointer; }
        .marker.selected { background: #007bff; color: white; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>管线功能测试</h1>
    
    <div class="test-section">
        <h3>1. 模拟管点创建</h3>
        <button onclick="createTestPoint()">创建测试管点</button>
        <div id="markers-display"></div>
    </div>
    
    <div class="test-section">
        <h3>2. 模拟管点点击</h3>
        <div id="clickable-markers"></div>
        <button onclick="startPipelineMode()">启动管线模式</button>
        <button onclick="resetSelection()">重置选择</button>
    </div>
    
    <div class="test-section">
        <h3>3. 测试日志</h3>
        <div id="log"></div>
    </div>

    <script>
        let markers = [];
        let currentTool = '';
        let pipelineMode = false;
        let selectedPoints = [];

        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += '<div class="log">' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function createTestPoint() {
            const id = String(Date.now());
            const title = '16YS' + (markers.length + 1);
            
            const marker = {
                id: id,
                title: title,
                latitude: 39.909 + Math.random() * 0.01,
                longitude: 116.397 + Math.random() * 0.01
            };
            
            markers.push(marker);
            log(`创建管点: ID=${id} (${typeof id}), 标题=${title}`);
            updateDisplay();
        }

        function updateDisplay() {
            // 更新标记显示
            const markersDiv = document.getElementById('markers-display');
            markersDiv.innerHTML = markers.map(m => 
                `<div>ID: ${m.id} (${typeof m.id}) - 标题: ${m.title}</div>`
            ).join('');
            
            // 更新可点击标记
            const clickableDiv = document.getElementById('clickable-markers');
            clickableDiv.innerHTML = markers.map(m => 
                `<div class="marker ${selectedPoints.find(p => p.id === m.id) ? 'selected' : ''}" 
                     onclick="onMarkerClick('${m.id}')">${m.title}</div>`
            ).join('');
        }

        function startPipelineMode() {
            currentTool = 'line';
            pipelineMode = true;
            selectedPoints = [];
            log('启动管线模式');
            updateDisplay();
        }

        function resetSelection() {
            selectedPoints = [];
            pipelineMode = false;
            currentTool = '';
            log('重置选择');
            updateDisplay();
        }

        function onMarkerClick(markerId) {
            log(`点击管点: markerId=${markerId} (${typeof markerId})`);
            log(`当前工具: ${currentTool}, 管线模式: ${pipelineMode}`);
            
            if (currentTool !== 'line') {
                log('❌ 请先启动管线模式');
                return;
            }

            // 查找marker
            let marker = markers.find(m => m.id === markerId);
            if (!marker) marker = markers.find(m => m.id === String(markerId));
            if (!marker) marker = markers.find(m => m.id === Number(markerId));
            
            if (!marker) {
                log('❌ 未找到管点信息');
                return;
            }

            // 检查是否已选择
            if (selectedPoints.find(p => p.id === marker.id)) {
                log('❌ 该管点已被选择');
                return;
            }

            selectedPoints.push(marker);
            log(`✅ 选择管点: ${marker.title}, 已选择数量: ${selectedPoints.length}`);

            if (selectedPoints.length === 1) {
                log('✅ 已选择起点，请选择终点');
            } else if (selectedPoints.length === 2) {
                log('✅ 两个点都选择完成，可以创建管线');
            }

            updateDisplay();
        }

        // 初始化
        log('测试页面初始化完成');
    </script>
</body>
</html>